# *Project22: research report on MPT

## MPT简介

Merkle Patricia Tree（梅克尔帕特里夏树）是一种用于存储和验证大量数据的树状数据结构。它是以密码学家Ralph Merkle和计算机科学家Leslie Lamport、Manuel Pérez-Corradini的名字命名的。

Merkle Patricia Tree的主要特点是高效、安全和可验证。它被广泛应用于区块链技术中，如以太坊等。该数据结构可以有效地保存大量的键值对，并提供高效的查找、插入和删除操作。其基本原理是将数据按照键（key）进行哈希处理，然后构建树形结构。每个节点都是由子节点的哈希值通过哈希计算得到的。树的根节点就是所有数据的最终哈希值，通过根节点的哈希值，可以验证整个树的完整性。

在Merkle Patricia Tree中，数据的访问和查找是非常高效的。当需要查找某个键对应的值时，可以通过键的哈希值沿着树的路径向下查找，直到找到对应的叶节点，然后返回该叶节点的值。这个过程的时间复杂度是O(log n)，其中n是树中节点的数量。

Merkle Patricia Tree还具有安全性和可验证性。由于每个节点的哈希值都依赖于其子节点的哈希值，如果有任何数据被篡改，整个树的哈希值将会改变，从而使得数据的完整性得到验证。

总的来说，Merkle Patricia Tree是一种高效、安全和可验证的树状数据结构，被广泛应用于区块链和分布式数据库等领域，帮助保障数据的完整性和安全性。

Merkle Patricia Tree融合了默克尔树和前缀树两种树结构优点，先来介绍前缀树和默克尔树。

## 前缀树

前缀树用于高效地存储和检索字符串集合。它被广泛应用于字符串处理和搜索问题。前缀树的主要特点是，每个节点代表一个字符串的字符，从根节点到叶节点的路径构成了一个完整的字符串。

### 前缀树的基本特点和特性：

#### 树状结构：

根节点不包含字符，除根节点以外每个节点只包含一个字符

从根节点到某一个节点，自上而下，路径上经过的字符连接起来就为目的节点对应的字符串。

每个节点的分支数目取决于key值的元素的取值范围，比如上图中每个节点会产生26个英文字母的分叉。

trie树的查找效率取决于key的长度，key长度越长也就越耗时。


#### 共享前缀：前缀树中的节点之间可能共享相同的前缀。这使得前缀树非常适合存储和检索具有共同前缀的字符串。

#### 查找和插入：在前缀树中，查找一个字符串或插入一个新的字符串的时间复杂度与字符串的长度相关，即O(L)，其中L是字符串的长度。

#### 快速搜索：前缀树可以高效地搜索具有相同前缀的所有字符串。这使得它在自动补全、拼写检查和搜索引擎等应用中有广泛的应用。

#### 空间开销：前缀树的空间开销相对较大，因为它可能存储许多共享前缀的字符串。

#### 适用性：前缀树特别适用于处理字符串集合的问题，例如查找、排序、匹配等。

### trie树缺点

![image](https://github.com/chunqingshaonv/homework-group-79/assets/139244994/e1b041b2-07d7-4acd-abec-7437e730cb55)


从上图可以看到，非根节点存储的是一个字符，这样会导致树的层级会比较高，因此导致trie树会消耗大量的内存。

下面通过Patricia Trie树来改进。

### Patricia Trie树

Patricia Trie树是一种升级版的trie树，不同之处在于：非根节点可以存储字符串，而不是只能存储字符，也就是路径压缩了的trie，因此节省了在内存空间的开销。

patricia trie树进行了路径压缩，占用的空间更少。若再插入一个新单词，原本压缩的路径可能需要扩展开来，这取决于插入的键的分布的稀疏情况，分布越稀疏，压缩的效果就越好。在以太坊中的地址为160位的，因此地址可能有2^160种，这个数值非常大，所以非常稀疏，因此patricia trie树很适合以太坊。

## 默克尔树

默克尔树是哈希树的变种，由计算机科学家Ralph Merkle在1979年提出。默克尔树的主要应用是在数据完整性验证和区块链中。它的设计目的是高效、安全地验证大量数据的完整性，特别是用于大规模分布式系统中。

### 默克尔树的基本原理：

数据划分：将大量数据分成固定大小的块（通常是2的幂次方大小），如果数据长度不够，可以用空白填充。

哈希计算：对每个数据块进行哈希计算，产生唯一的哈希值。默克尔树通常使用加密哈希函数（如SHA-256）来生成哈希值。

层级构建：将生成的哈希值两两组合，形成上一层的哈希节点。如果数据块的数量为奇数，可以复制最后一个哈希值作为一个空节点进行配对。

递归构建：重复以上步骤，直到生成一个根节点，即默克尔树的顶层节点。根节点的哈希值被称为默克尔树根哈希，它代表整个数据集的完整性。

### 默克尔树的特点和优势：

高效验证：默克尔树允许快速验证特定数据块是否属于数据集，只需计算和比较相对较少的哈希值。

数据完整性：通过比较根哈希值，可以高度可靠地检测数据是否被篡改，即使其中一小部分数据被改变也能被发现。

空间效率：默克尔树的空间需求相对较小，只需要存储哈希值而不是整个数据块。

并行计算：在大规模分布式系统中，默克尔树可以被并行计算和验证，提高系统性能。

默克尔树在区块链技术中起着重要作用，例如比特币区块链中的交易数据就是使用默克尔树进行存储和验证。通过默克尔树的数据完整性验证，区块链可以保证数据的安全性和不可篡改性。同时，默克尔树在其他领域也有广泛的应用，例如P2P网络中的数据验证、文件系统的校验等。

## MPT结构分析

MPT由节点组成，每个节点都有一个唯一的256位的哈希值来表示其内容。MPT的每个叶节点包含一个键值对，其中键是用于查找和访问数据的唯一标识符，而值是与该键关联的数据。

MPT采用路径压缩技术来减少冗余存储。在MPT中，如果两个相邻节点的子节点哈希值相同，可以将它们合并成一个节点，从而减少存储空间和加快查找速度。
节点可能共享相同的前缀，这使得它能够高效地存储具有相同前缀的键值对。在MPT中，每个节点的哈希值是其子节点哈希值的哈希结果，这样可以确保整个树的哈希值在数据变化时能够快速更新。

### MPT的结构：

空节点（Null Node）：一个空节点表示一个空白或未存储的位置，通常用“NULL”来表示。它没有键值对，也没有哈希值。

叶节点（Leaf Node）：叶节点包含一个键值对，其中键和值都是存储的数据。叶节点的哈希值是由其键和值计算得出。

扩展节点（Extension Node）：扩展节点包含一个共享前缀和一个子节点的哈希值。它没有直接的键值对，而是用于表示一个或多个子节点的前缀共享。

分支节点（Branch Node）：分支节点包含一个16个子节点的数组，用于存储子节点的哈希值。每个子节点都对应一个特定的键前缀。

根节点（Root Node）：根节点是整个MPT的顶层节点，它是通过哈希计算得出的唯一值。根节点的哈希值用于验证整个MPT的完整性和安全性。

其中叶子节点与扩展节点的定义相似，如下所示：
~~~
type shortNode struct {
        Key   []byte
        Val   node
        flags nodeFlag}
~~~

Key用来存储属于该节点范围的key，Val用来存储该节点的内容。

Key是MPT树实现树高压缩的关键，当MPT试图插入一个节点，插入过程中发现目前没有与该节点Key拥有相同前缀的路径。此时MPT把剩余的Key存储在叶子／扩展节点的Key字段中，充当一个”Shortcut“。

#### 优势：
提高节点的查找效率，避免过多的磁盘访问；
减少存储空间浪费，避免存储无用的节点；

### Merkle Patricia Tree（key,val）中的val

采用RLP（Recursive Length Prefix）编码方式，用于对数据进行序列化和压缩的编码方法。RLP编码通常用于以太坊区块链中，包括存储交易、状态树和合约等数据。

#### RLP编码规则有：

1.单字节字符串：如果字符串的长度为1个字节且数值范围为0到127（0x00到0x7f），则该字节直接表示字符串的内容。

2.短字符串：如果字符串的长度小于56个字节，则将长度字节与字符串数据拼接在一起。长度字节是一个单字节整数，其值等于字符串的长度加上0x80。

3.长字符串：如果字符串的长度大于等于56个字节，则将长度字节与字符串长度的编码拼接在一起，然后再与字符串数据拼接在一起。长度字节是一个前缀为0xb7加上字符串长度的编码。

4.列表：列表的编码与字符串类似，不同之处在于长度字节的前缀。长度字节的前缀是一个前缀为0xc0加上列表长度的编码。

通过以上规则，MPT的键值对数据被RLP编码后可以节约空间，并且方便存储和检索。RLP编码是一种无损的编码方式，即通过解码可以完全还原原始数据。这使得RLP编码在区块链技术中特别适合用于存储和传输大量数据，并确保数据的完整性和正确性。

## MPT的一些主要应用

Merkle Patricia Tree（MPT）作为一种高效、安全和可验证的树状数据结构，在密码学和分布式系统中有广泛的应用，尤其在区块链技术中被广泛采用。

1.  区块链技术：MPT是许多区块链平台的核心数据结构之一，如以太坊、Hyperledger Fabric等。在区块链中，交易和状态数据通常被存储在MPT中，通过哈希值连接形成一个不可篡改的链式结构。MPT的高效查找和验证能力使得区块链的交易和状态更新能够快速完成，同时保证数据的安全性和完整性。

2. 分布式数据库：MPT用于分布式数据库系统中，用于存储和管理大量的键值对数据。通过MPT的哈希索引，可以快速查找和验证数据库中的数据。在分布式系统中，MPT还可以帮助实现数据的一致性和同步。

3. 数字证书：MPT存储和管理数字证书，例如SSL证书。数字证书通常包含公钥、私钥和数字签名等信息，通过MPT的高效哈希索引，可以快速查找和验证证书的有效性和完整性。

4. 存储验证：MPT验证存储系统中的数据完整性。通过构建MPT树，将存储的数据按照哈希值进行组织，并将根节点的哈希值与预期值进行比较，可以验证存储中的数据是否被篡改。

5. 安全身份验证：MPT存储和验证用户的身份信息，例如用户名、密码等。通过MPT的哈希索引，可以快速验证用户的身份信息是否正确。

Merkle Patricia Tree作为一种高效、安全和可验证的数据结构，广泛应用于密码学、区块链、分布式系统等领域。它在保障数据完整性和安全性方面具有重要的作用，是许多现代分布式系统和安全系统的核心组件之一。

